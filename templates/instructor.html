<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privilege Walk - Instructor View</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .session-name {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .session-id {
            color: #666;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: flex;
            gap: 3rem;
            max-width: 1200px;
            margin: 0 auto;
            align-items: flex-start;
        }
        
        .left-panel {
            flex: 1;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .right-panel {
            flex: 1;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .network-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }
        
        .network-info h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .ip-address {
            background: #667eea;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            margin: 0.5rem 0;
        }
        
        .ip-note {
            color: #666;
            font-size: 0.9rem;
            margin: 0.5rem 0 0 0;
            text-align: center;
        }
        
        .qr-container {
            margin: 2rem 0;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: 10px;
        }
        
        .qr-instructions {
            margin-bottom: 2rem;
            text-align: left;
        }
        
        .qr-instructions ol {
            text-align: left;
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .qr-instructions li {
            margin: 0.5rem 0;
            color: #555;
        }
        
        .qr-code {
            margin: 1rem 0;
        }
        
        .qr-controls {
            margin: 1rem 0;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        
        .join-url {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            margin: 1rem 0;
            word-break: break-all;
        }
        
        .debug-info {
            font-size: 0.8rem;
            color: #888;
            margin-top: 1rem;
        }
        
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 600;
        }
        
        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.finished {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .testing-note {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #007bff;
        }
        
        .user-count {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 1rem 0;
        }
        
        .go-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }
        
        .go-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .go-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .user-list {
            margin-top: 1rem;
        }
        
        .user-item {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .user-count-display {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
            text-align: center;
        }
        
        .total-users {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0056b3;
        }
        
        .question-progress-display {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ffc107;
        }
        
        .question-progress-display.all-answered {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .question-progress-display h3 {
            margin: 0 0 0.5rem 0;
            color: #856404;
            font-size: 1rem;
        }
        
        .question-progress-display.all-answered h3 {
            color: #155724;
        }
        
        .current-question {
            font-weight: 600;
            color: #856404;
            margin-bottom: 0.5rem;
        }
        
        .question-progress-display.all-answered .current-question {
            color: #155724;
        }
        
        .answered-status {
            font-size: 0.9rem;
            color: #856404;
        }
        
        .question-progress-display.all-answered .answered-status {
            color: #155724;
        }
        
        .next-question-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .next-question-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .user-item.answered {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .user-item.pending {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .privilege-walk-view {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .walk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .question-display {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .question-text {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .question-progress {
            color: #666;
            font-size: 1.1rem;
        }
        
        .walk-container {
            position: relative;
            height: 600px;
            background: linear-gradient(to bottom, #e8f5e8 0%, #f0f8f0 50%, #f8e8e8 100%);
            border-radius: 10px;
            border: 2px solid #ddd;
            margin: 2rem 0;
        }
        
        .user-marker {
            position: absolute;
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.5s ease;
            font-size: 0.9rem;
        }
        
        .user-marker.answered {
            background: #28a745;
        }
        
        .user-marker.pending {
            background: #ffc107;
            color: #333;
        }
        
        .final-results {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .final-positions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .position-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .position-rank {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .position-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .position-value {
            color: #666;
        }
        
        .session-actions {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #eee;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .action-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .new-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="session-name">{{ session_name }}</h1>
        <p class="session-id">Session ID: {{ session_id }}</p>
    </div>
    
    <div class="main-content">
        <div class="left-panel">
            <h2>📱 Student Join</h2>
            
            {% if network_ip %}
            <div class="network-info">
                <h3>🌐 Network Information</h3>
                <p><strong>Your computer's IP address:</strong></p>
                <div class="ip-address">{{ network_ip }}</div>
                <p class="ip-note">Students must be on the same network to connect</p>
                
                <div style="margin-top: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #0056b3;">🔧 Troubleshooting Tips</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem; color: #0056b3;">
                        <li>Make sure students are connected to the same WiFi network</li>
                        <li>If students can't connect, try refreshing the IP address</li>
                        <li>Some corporate networks may block local connections</li>
                        <li>Test the QR code with your own phone first</li>
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <div class="qr-container">
                <div class="qr-instructions">
                    <h3>📱 How Students Join</h3>
                    <ol>
                        <li>Students scan this QR code with their phone camera</li>
                        <li>They'll be taken to a join page</li>
                        <li>They enter a nickname (can be fake)</li>
                        <li>They'll see "Please wait" until you start</li>
                    </ol>
                </div>
                <div class="qr-code">
                    <img id="qrCodeImage" src="/qr/{{ session_id }}" alt="QR Code for joining session" style="max-width: 300px; height: auto;">
                    <div class="qr-controls">
                        <button onclick="refreshQRCode()" class="refresh-btn">🔄 Refresh QR Code</button>
                    </div>
                </div>
                <div class="join-url">http://{{ network_ip }}:5001/join/{{ session_id }}</div>
                <div class="debug-info">
                    <small>Debug: QR code points to: <code>http://{{ network_ip }}:5001/join/{{ session_id }}</code></small>
                    <br><small>💡 The QR code automatically uses your network IP address so students can connect!</small>
                    <div style="margin-top: 0.5rem;">
                        <button onclick="refreshIPAddress()" style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 0.8rem;">
                            🔄 Refresh IP
                        </button>
                        <button onclick="copyJoinURL()" style="padding: 0.25rem 0.5rem; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 0.8rem;">
                            📋 Copy URL
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="status waiting" id="status">
                Waiting for students to join...
            </div>
            
            <div class="testing-note">
                <p><strong>💡 Testing Tip:</strong> Test the QR code with your own phone first to make sure it works!</p>
            </div>
            
            <div class="user-count" id="userCount">0</div>
            <p>Students joined</p>
            
            <button class="go-button" id="goButton" disabled>
                🚀 Start Privilege Walk
            </button>
            
            <div class="debug-controls" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <p><strong>🐛 Debug Controls:</strong></p>
                <button onclick="testViewTransition()" style="margin: 0.5rem; padding: 0.5rem; background: #007bff; color: white; border: none; border-radius: 4px;">
                    Test View Transition
                </button>
                <button onclick="showPrivilegeWalkView()" style="margin: 0.5rem; padding: 0.5rem; background: #28a745; color: white; border: none; border-radius: 4px;">
                    Force Show Walk View
                </button>
                <button onclick="showMainView()" style="margin: 0.5rem; padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px;">
                    Force Show Main View
                </button>
            </div>
        </div>
        
        <div class="right-panel">
            <h2>👥 Connected Students</h2>
            <div class="user-count-display">
                <div class="total-users">Total: <span id="totalUserCount">0</span></div>
            </div>
            <div class="question-progress-display" id="questionProgressDisplay" style="display: none;">
                <h3>📝 Question Progress</h3>
                <div class="current-question" id="currentQuestionDisplay"></div>
                <div class="answered-status" id="answeredStatusDisplay"></div>
                <button class="next-question-btn" id="nextQuestionBtn" style="display: none;" onclick="advanceToNextQuestion()">
                    ➡️ Next Question
                </button>
            </div>
            <div class="user-list" id="userList">
                <p style="text-align: center; color: #666;">No students joined yet</p>
            </div>
        </div>
    </div>
    
    <div class="privilege-walk-view" id="privilegeWalkView">
        <div class="walk-header">
            <h2>🚶‍♂️ Privilege Walk in Progress</h2>
            <button onclick="showMainView()" class="back-btn">← Back to Setup</button>
        </div>
        
        <div class="question-display" id="questionDisplay">
            <div class="question-text" id="questionText"></div>
            <div class="question-progress" id="questionProgress"></div>
        </div>
        
        <div class="walk-container" id="walkContainer">
            <!-- User markers will be dynamically added here -->
        </div>
    </div>
    
    <div class="final-results" id="finalResults">
        <h2>🏁 Final Results</h2>
        <div class="final-positions" id="finalPositions">
            <!-- Final positions will be displayed here -->
        </div>
        
        <div class="session-actions">
            <h3>🔄 What would you like to do next?</h3>
            <div class="action-buttons">
                <button onclick="resetSession()" class="action-btn reset-btn">
                    🔄 Reset Session (Same Students, New Questions)
                </button>
                <button onclick="createNewSession()" class="action-btn new-btn">
                    🆕 Create New Session (Fresh Start)
                </button>
                <button onclick="showMainView()" class="action-btn back-btn">
                    ← Back to Setup
                </button>
            </div>
        </div>
    </div>

    <script>
        const sessionId = '{{ session_id }}';
        const networkIp = '{{ network_ip }}';
        
        let users = {};
        let sessionStatus = 'waiting';
        let pollInterval = null;
        let currentQuestion = 0;
        let totalQuestions = 0;
        let questionText = '';
        let userAnswers = {};

        function startPolling() {
            // Poll every 2 seconds for updates
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/session_status/${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        handleStatusUpdate(data);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function handleStatusUpdate(data) {
            console.log('Status update received:', data);
            
            // Update user count and list
            if (data.users) {
                users = {};
                data.users.forEach(username => {
                    users[username] = { joined_at: new Date() };
                });
                updateUserCount();
                updateUserList();
                updateGoButton();
            }
            
            // Update session status
            if (data.status && data.status !== sessionStatus) {
                sessionStatus = data.status;
                updateStatus();
                
                if (sessionStatus === 'active') {
                    showPrivilegeWalkView();
                    loadCurrentQuestion();
                    createUserMarkers();
                } else if (sessionStatus === 'finished') {
                    loadFinalResults();
                }
            }
            
            // Update question progress
            if (data.current_question !== undefined && data.current_question !== currentQuestion) {
                currentQuestion = data.current_question;
                totalQuestions = data.total_questions;
                loadCurrentQuestion();
                updateQuestionProgress();
            }
            
            // Load user positions and answers
            if (sessionStatus === 'active') {
                loadUserPositions();
                loadUserAnswers();
            }
        }

        async function loadCurrentQuestion() {
            try {
                const response = await fetch(`/api/question/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    questionText = data.question;
                    updateQuestionDisplay(data.question, data.question_number, data.total_questions);
                }
            } catch (error) {
                console.error('Error loading question:', error);
            }
        }

        async function loadUserPositions() {
            try {
                const response = await fetch(`/api/positions/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateUserPositions(data.positions);
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function loadUserAnswers() {
            try {
                // Get current user answer status from the dedicated endpoint
                const response = await fetch(`/api/user_answers/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update user answers based on the API response
                    userAnswers = {};
                    if (data.user_answers) {
                        Object.keys(data.user_answers).forEach(username => {
                            userAnswers[username] = data.user_answers[username].answered;
                        });
                    }
                    
                    updateUserAnswerStatus(data);
                }
            } catch (error) {
                console.error('Error loading user answers:', error);
            }
        }

        function updateUserAnswerStatus(data) {
            // Initialize user answers for current question
            Object.keys(users).forEach(username => {
                if (!(username in userAnswers)) {
                    userAnswers[username] = false;
                }
            });
            
            // Check if we need to update answer status based on question progress
            if (data.current_question !== undefined && data.current_question !== currentQuestion) {
                // New question started, reset all answers
                Object.keys(userAnswers).forEach(username => {
                    userAnswers[username] = false;
                });
            }
            
            // Update question progress display
            updateQuestionProgress();
            updateUserList();
            
            // Update markers if privilege walk view is active
            if (document.getElementById('privilegeWalkView').style.display !== 'none') {
                createUserMarkers();
            }
        }

        function updateQuestionProgress() {
            const questionProgressDisplay = document.getElementById('questionProgressDisplay');
            const currentQuestionDisplay = document.getElementById('currentQuestionDisplay');
            const answeredStatusDisplay = document.getElementById('answeredStatusDisplay');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            
            if (questionProgressDisplay && currentQuestionDisplay && answeredStatusDisplay) {
                questionProgressDisplay.style.display = 'block';
                currentQuestionDisplay.textContent = `Question ${currentQuestion + 1} of ${totalQuestions}: ${questionText}`;
                
                // Count answered vs pending users
                const answeredCount = Object.values(userAnswers).filter(answered => answered).length;
                const totalUsers = Object.keys(users).length;
                const pendingCount = totalUsers - answeredCount;
                
                answeredStatusDisplay.innerHTML = `
                    <div>✅ Answered: ${answeredCount}/${totalUsers}</div>
                    <div>⏳ Pending: ${pendingCount}/${totalUsers}</div>
                `;
                
                // Update user list to reflect current answer status
                updateUserList();

                // Check if all users have answered the current question
                if (answeredCount === totalUsers && totalUsers > 0) {
                    questionProgressDisplay.classList.add('all-answered');
                    answeredStatusDisplay.innerHTML += `
                        <div style="margin-top: 0.5rem; font-weight: 600; color: #155724;">
                            🎉 All users have answered! Ready for next question.
                        </div>
                    `;
                    nextQuestionBtn.style.display = 'block'; // Show next question button
                } else {
                    questionProgressDisplay.classList.remove('all-answered');
                    nextQuestionBtn.style.display = 'none'; // Hide next question button
                }
            }
        }

        async function loadFinalResults() {
            try {
                const response = await fetch(`/api/positions/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    showFinalResults(data.positions);
                }
            } catch (error) {
                console.error('Error loading final results:', error);
            }
        }

        function updateStatus() {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                if (sessionStatus === 'waiting') {
                    statusElement.textContent = 'Waiting for students to join...';
                    statusElement.className = 'status waiting';
                } else if (sessionStatus === 'active') {
                    statusElement.textContent = 'Privilege Walk in progress...';
                    statusElement.className = 'status active';
                } else if (sessionStatus === 'finished') {
                    statusElement.textContent = 'Session finished!';
                    statusElement.className = 'status finished';
                }
            }
        }

        function updateUserCount() {
            const userCountElement = document.getElementById('userCount');
            if (userCountElement) {
                userCountElement.textContent = Object.keys(users).length;
            }
        }

        function updateUserList() {
            const userListElement = document.getElementById('userList');
            if (userListElement) {
                if (Object.keys(users).length === 0) {
                    userListElement.innerHTML = '<p style="text-align: center; color: #666;">No students joined yet</p>';
                } else {
                    userListElement.innerHTML = Object.keys(users).map(username => {
                        const hasAnswered = userAnswers[username] || false;
                        const statusClass = hasAnswered ? 'answered' : 'pending';
                        const statusIcon = hasAnswered ? '✅' : '⏳';
                        const statusText = hasAnswered ? 'Answered' : 'Pending';
                        
                        return `<div class="user-item ${statusClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>👤 ${username}</span>
                                <span style="font-size: 0.9rem; color: #666;">${statusIcon} ${statusText}</span>
                            </div>
                        </div>`;
                    }).join('');
                }
            }
        }

        function updateGoButton() {
            const goButton = document.getElementById('goButton');
            if (goButton) {
                goButton.disabled = Object.keys(users).length === 0;
            }
        }

        function showMainView() {
            document.querySelector('.main-content').style.display = 'flex';
            document.getElementById('privilegeWalkView').style.display = 'none';
            document.getElementById('finalResults').style.display = 'none';
        }

        function showPrivilegeWalkView() {
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('privilegeWalkView').style.display = 'block';
            document.getElementById('finalResults').style.display = 'none';
        }

        async function resetSession() {
            // Reset the current session for new questions
            if (confirm('Reset this session? Students will keep their usernames but start fresh questions.')) {
                try {
                    const response = await fetch('/api/reset_session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // Hide final results
                        document.getElementById('finalResults').style.display = 'none';
                        // Show privilege walk view again
                        showPrivilegeWalkView();
                        // Reset session state
                        sessionStatus = 'waiting';
                        updateStatus();
                        // Clear previous results
                        document.getElementById('walkContainer').innerHTML = '';
                        // Re-enable go button
                        document.getElementById('goButton').disabled = false;
                    }
                } catch (error) {
                    console.error('Error resetting session:', error);
                    alert('Error resetting session');
                }
            }
        }

        function showFinalResults(finalPositions) {
            const finalResults = document.getElementById('finalResults');
            const finalPositionsDiv = document.getElementById('finalPositions');
            
            // Sort by position (highest first)
            const sortedPositions = Object.entries(finalPositions)
                .sort(([,a], [,b]) => b - a);
            
            finalPositionsDiv.innerHTML = sortedPositions.map(([username, position], index) => `
                <div class="position-card">
                    <div class="position-rank">#${index + 1}</div>
                    <div class="position-name">${username}</div>
                    <div class="position-value">Position: ${position.toFixed(1)}</div>
                </div>
            `).join('');
            
            finalResults.style.display = 'block';
        }

        function updateQuestionDisplay(question, questionNumber, totalQuestions) {
            const questionText = document.getElementById('questionText');
            const questionProgress = document.getElementById('questionProgress');
            
            if (questionText) questionText.textContent = question;
            if (questionProgress) questionProgress.textContent = `Question ${questionNumber} of ${totalQuestions}`;
        }

        function createUserMarkers() {
            const container = document.getElementById('walkContainer');
            const userCount = Object.keys(users).length;
            
            if (userCount === 0) return;
            
            // Calculate dynamic spacing based on user count
            let sectionWidth;
            if (userCount <= 2) {
                sectionWidth = 100 / userCount; // 50% each for 2 users
            } else if (userCount <= 10) {
                sectionWidth = 80 / userCount; // 80% of width, some spacing
            } else {
                sectionWidth = 60 / userCount; // 60% of width, more spacing
            }
            
            container.innerHTML = '';
            
            Object.keys(users).forEach((username, index) => {
                const marker = document.createElement('div');
                marker.className = 'user-marker';
                marker.id = `marker-${username}`;
                marker.textContent = username;
                
                // Calculate horizontal position with dynamic spacing
                const leftPosition = (index * sectionWidth) + (sectionWidth / 2) - 60;
                marker.style.left = `${Math.max(10, Math.min(container.offsetWidth - 130, leftPosition))}px`;
                marker.style.top = '270px'; // Center vertically
                
                // Set initial answer status
                const hasAnswered = userAnswers[username] || false;
                marker.classList.add(hasAnswered ? 'answered' : 'pending');
                
                container.appendChild(marker);
            });
        }

        function updateUserPositions(positions) {
            Object.keys(positions).forEach(username => {
                const marker = document.getElementById(`marker-${username}`);
                if (marker) {
                    // Convert position to screen coordinates
                    // Position ranges from -100 to +100, convert to 0-600px
                    const screenY = 300 - (positions[username] * 3); // 300 is center, 3 is scale factor
                    marker.style.top = `${Math.max(0, Math.min(540, screenY))}px`;
                    
                    // Update answer status
                    const hasAnswered = userAnswers[username] || false;
                    marker.className = `user-marker ${hasAnswered ? 'answered' : 'pending'}`;
                }
            });
            
            // Update user list to reflect answer status
            updateUserList();
        }

        function createNewSession() {
            // Create a completely new session
            if (confirm('Create a new session? This will generate a new QR code and session ID.')) {
                window.location.href = '/';
            }
        }

        function testViewTransition() {
            console.log('=== TESTING VIEW TRANSITION ===');
            console.log('Current session status:', sessionStatus);
            console.log('Current users:', users);
            
            // Test the transition manually
            showPrivilegeWalkView();
            
            // After 3 seconds, go back
            setTimeout(() => {
                console.log('Going back to main view...');
                showMainView();
            }, 3000);
        }

        // Function to refresh QR code
        function refreshQRCode() {
            const qrImage = document.getElementById('qrCodeImage');
            const timestamp = new Date().getTime();
            qrImage.src = `/qr/{{ session_id }}?t=${timestamp}`;
        }

        // Function to refresh IP address display
        function refreshIPAddress() {
            // Reload the page to get updated IP address
            window.location.reload();
        }

        // Function to copy join URL to clipboard
        function copyJoinURL() {
            const joinURL = `http://${networkIp}:5001/join/${sessionId}`;
            navigator.clipboard.writeText(joinURL).then(function() {
                alert('Join URL copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }

        // Handle go button click
        document.getElementById('goButton').addEventListener('click', async function() {
            console.log('🚀 GO BUTTON CLICKED!');
            try {
                console.log('Sending start session request...');
                const response = await fetch('/api/start_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                const data = await response.json();
                console.log('Start session response:', data);
                if (!data.success) {
                    alert('Error starting session: ' + data.error);
                } else {
                    console.log('✅ Session start request successful');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting session');
            }
        });

        // Handle next question button click
        document.getElementById('nextQuestionBtn').addEventListener('click', async function() {
            console.log('Next Question Button Clicked!');
            try {
                const response = await fetch(`/api/advance_question/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await response.json();
                console.log('Advance question response:', data);
                if (data.success) {
                    console.log('✅ Question advanced successfully');
                    // Reload current question and progress
                    await loadCurrentQuestion();
                    updateQuestionProgress();
                    // Re-create user markers to update their positions
                    createUserMarkers();
                } else {
                    alert('Error advancing question: ' + data.error);
                }
            } catch (error) {
                console.error('Error advancing question:', error);
                alert('Error advancing question');
            }
        });

        // Function to advance to next question (called from onclick)
        async function advanceToNextQuestion() {
            console.log('Next Question Button Clicked!');
            try {
                const response = await fetch(`/api/advance_question/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await response.json();
                console.log('Advance question response:', data);
                if (data.success) {
                    console.log('✅ Question advanced successfully');
                    // Reload current question and progress
                    await loadCurrentQuestion();
                    updateQuestionProgress();
                    // Re-create user markers to update their positions
                    createUserMarkers();
                } else {
                    alert('Error advancing question: ' + data.error);
                }
            } catch (error) {
                console.error('Error advancing question:', error);
                alert('Error advancing question');
            }
        }

        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startPolling();
        });

        // Clean up polling when page unloads
        window.addEventListener('beforeunload', function() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });
    </script>
</body>
</html> 